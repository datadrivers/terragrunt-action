# Terraform Plan PR Commenter

A composite GitHub Action that converts Terraform plan files to JSON and posts formatted PR comments via [`liatrio/terraform-change-pr-commenter`](https://github.com/liatrio/terraform-change-pr-commenter).

## Overview

This action automates the process of:

1. Converting Terraform/Terragrunt plan files (binary format) to JSON
2. Posting formatted, human-readable comments on pull requests summarizing the planned changes

## Inputs

| Input                            | Description                                          | Required | Default                  |
| -------------------------------- | ---------------------------------------------------- | -------- | ------------------------ |
| `terraform-plan-filename`        | Name for terraform plan files                        | No       | `terraform.tfplan`       |
| `use-automatic-binary-detection` | Auto-detect terraform/terragrunt binary              | No       | `true`                   |
| `enable-debug`                   | Enable debug output                                  | No       | `false`                  |
| `include-plan-job-summary`       | Include plan in GitHub job summary                   | No       | `true`                   |
| `pr-commenter-comment-header`    | Header text for the PR comment                       | No       | `Terraform Plan Changes` |
| `pr-commenter-comment-footer`    | Footer text for the PR comment                       | No       | (empty)                  |
| `continue-on-error`              | Continue even if the commenter fails                 | No       | `true`                   |
| `github-token`                   | GitHub token for posting PR comments                 | No       | `${{ github.token }}`    |
| `working-directory`              | Working directory to run the action in               | No       | `.`                      |

## Outputs

| Output | Description |
|--------|-------------|
| `terraform_planfiles_json` | Newline-separated list of generated tfplan JSON files |

## Usage

### Basic Example

```yaml
- name: Comment Terraform Plan on PR
  uses: datadrivers/terragrunt-action/terraform-pr-commenter@v1
  with:
    terraform-plan-filename: terraform.tfplan
    github-token: ${{ github.token }}
```

### Advanced Example

```yaml
- name: Comment Terraform Plan on PR
  uses: datadrivers/terragrunt-action/terraform-pr-commenter@v1
  with:
    terraform-plan-filename: terraform.tfplan
    use-automatic-binary-detection: true
    enable-debug: false
    include-plan-job-summary: true
    pr-commenter-comment-header: "ðŸ“‹ Terraform Plan Changes"
    pr-commenter-comment-footer: "Generated by Terragrunt Action"
    continue-on-error: false
    github-token: ${{ secrets.GITHUB_TOKEN }}
    working-directory: ./terraform
```

## How It Works

1. **Plan Conversion**: The `convert_plan_to_json.sh` script converts Terraform/Terragrunt binary plan files to JSON format
2. **Binary Detection**: Automatically detects whether to use `terraform` or `terragrunt` binary (if enabled)
3. **PR Commenting**: Posts a formatted comment on the pull request using `liatrio/terraform-change-pr-commenter`
4. **Job Summary**: Optionally includes plan summary in GitHub job summary for visibility

## Requirements

- Plan files must exist in the specified working directory with the configured filename
- The action requires `contents: read` and `pull-requests: write` permissions (automatic with `GITHUB_TOKEN`)
- Terraform or Terragrunt binary must be available in the runner environment

## Notes

- The action is designed to work in pull request contexts
- Previous comments are automatically hidden when posting new ones (via `hide-previous-comments: true`)
- Set `continue-on-error: false` if you want the workflow to fail if commenting fails
