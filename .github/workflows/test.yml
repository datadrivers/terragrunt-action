name: Terraform Test

on:
  workflow_dispatch:
  pull_request:

defaults:
  run:
    shell: bash

# Use ENV vars to configure parameters for steps
env:
  DEFAULT_TERRAFORM_VERSION: 1.14.4
  DEFAULT_TERRAGRUNT_VERSION: 0.99.1

permissions: {}

jobs:
  test-terraform-pr-comment:
    name: TF code in examples/test-pr-comment
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment
          skip-caches: true
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terraform Plan Changes for test-pr-comment"
          pr-commenter-comment-footer: "Expecting plan of 1 created resource"
          enable-debug: true
  test-terragrunt-pr-comment:
    name: TF code in examples/test-pr-comment-terragrunt
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt
          skip-caches: false
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-terragrunt
        run: |
          terragrunt run --all -- init
          terragrunt run --all -- plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terragrunt Plan Changes for test-pr-comment-terragrunt"
          pr-commenter-comment-footer: "Expecting 2 plans of 1 created resource each"
          enable-debug: true
  test-terragrunt-pr-comment-no-plan:
    name: TF code in examples/test-pr-comment-terragrunt-no-plan
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt-no-plan
          skip-caches: false
          terragrunt-cache-extra-key: ${{ hashFiles('**/README.md') }}
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-terragrunt-no-plan
        run: |
          terragrunt run --all -- init
          terragrunt run --all -- plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terragrunt Plan Changes for test-pr-comment-terragrunt-no-plan"
          pr-commenter-comment-footer: "No plan was generated for this PR"
          enable-debug: true
  test-terragrunt-pr-comment-no-change:
    name: TF code in examples/test-pr-comment-terragrunt-no-change
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt-no-change
          skip-caches: true
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-terragrunt-no-change
        run: |
          terragrunt run --all -- init
          terragrunt run --all -- plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terragrunt Plan Changes for test-pr-comment-terragrunt-no-change"
          pr-commenter-comment-footer: "Expecting no changes in the PR comment"
          enable-debug: true
  test-terragrunt-pr-comment-with-no-summary:
    name: TF code in examples/test-pr-comment-terragrunt-with-no-summary
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt-with-no-summary
          skip-caches: false
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-terragrunt-with-no-summary
        run: |
          terragrunt run --all -- init
          terragrunt run --all -- plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terragrunt Plan Changes for test-pr-comment-terragrunt-with-no-summary"
          pr-commenter-comment-footer: "Expecting no summary in the PR comment, but 2 plans of 1 created resource each"
          include-plan-job-summary: false
          enable-debug: true
  test-terraform-pr-comment-with-binary-detection-override:
    name: TF code in examples/test-pr-comment-with-binary-detection-override
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-with-binary-detection-override
          skip-caches: true
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-with-binary-detection-override
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terraform Plan Changes for test-pr-comment-with-binary-detection-override"
          pr-commenter-comment-footer: "Expecting plan of 1 created resource"
          use-automatic-binary-detection: false
          enable-debug: true
  test-terraform-pr-comment-versionfile:
    name: TF code in examples/test-pr-detect-versionfile
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: "" # leave empty to detect from versionfile
          use-aws-auth: false
          working-directory: examples/test-pr-detect-versionfile
          skip-caches: false
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-detect-versionfile
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terraform Plan Changes for test-pr-detect-versionfile"
          pr-commenter-comment-footer: "Expecting plan of 1 created resource"
          enable-debug: true
  test-terraform-pr-comment-versionfile-terragrunt:
    name: TF code in examples/test-pr-detect-versionfile-terragrunt
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: "" # leave empty to detect from versionfile-terraform
          terragrunt-version: "" # leave empty to detect from versionfile-terragrunt
          use-aws-auth: false
          working-directory: examples/test-pr-detect-versionfile-terragrunt
          skip-caches: false
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-detect-versionfile-terragrunt
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          pr-commenter-comment-header: "Terraform Plan Changes for test-pr-detect-versionfile-terragrunt"
          pr-commenter-comment-footer: "Expecting plan of 1 created resource"
          enable-debug: true
  test-terraform-pr-comment-working-directory:
    name: TF code in examples/test-pr-comment-working-directory
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-working-directory
          skip-caches: true
          enable-debug: true # for prod use false here
      - working-directory: examples/test-pr-comment-working-directory/root
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: ./terraform-pr-commenter
        with:
          terraform-plan-filename: terraform.tfplan
          working-directory: examples/test-pr-comment-working-directory/root
          pr-commenter-comment-header: "Terraform Plan Changes for test-pr-comment-working-directory"
          pr-commenter-comment-footer: "Expecting plan of 2 created resources in subdirectory"
          enable-debug: true
  test-terraform-detect-versions:
    name: TF code in examples/test-pr-detect-versionfile-terragrunt (no PR comment)
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: "" # leave empty to detect from versionfile-terraform
          terragrunt-version: "" # leave empty to detect from versionfile-terragrunt
          use-aws-auth: false
          working-directory: examples/test-pr-detect-versionfile-terragrunt
          skip-caches: false
          enable-debug: true # for prod use false here
      - name: run commands
        working-directory: examples/test-pr-detect-versionfile-terragrunt
        run: |
          terraform init
          terraform plan -out terraform.tfplan # required to generate pr comments
  test-cache-scoping-stack-a:
    name: Test cache scoping - Stack A
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      lock-hash: ${{ steps.action.outputs.terraform-plugin-cache-dir }}
      tg-provider-cache-dir: ${{ steps.action.outputs.terragrunt-provider-cache-dir }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: action
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-cache-scoping/stack-a
          skip-caches: false
          enable-debug: true
      - name: Verify cache directory contains stack-a hash
        run: |
          cache_dir="${TF_PLUGIN_CACHE_DIR}"
          echo "TF Plugin Cache directory: $cache_dir"
          # Extract hash from path (last component)
          hash=$(basename "$cache_dir")
          echo "Hash: $hash"
          # Verify it's not a generic hash
          if [[ "$hash" == "no-lock" ]]; then
            echo "ERROR: Got generic 'no-lock' hash - scoping failed!"
            exit 1
          fi
          echo "✓ TF Plugin cache is scoped with unique hash: $hash"

          # Verify Terragrunt provider cache directory is the shared location under TG_DOWNLOAD_DIR
          tg_cache_dir="${TG_PROVIDER_CACHE_DIR}"
          tg_cache_dir="${tg_cache_dir//\/\//\/}" # normalize double slashes
          tg_cache_dir="${tg_cache_dir%/}" # trim trailing slash
          echo "TG Provider Cache directory: $tg_cache_dir"
          expected_path="$HOME/.terragrunt-cache/terragrunt/providers"
          if [[ "$tg_cache_dir" != "$expected_path" ]]; then
            echo "ERROR: TG provider cache is not using shared location!"
            echo "Expected: $expected_path"
            echo "Got: $tg_cache_dir"
            exit 1
          fi
          echo "✓ TG Provider cache uses shared location"
      - name: Initialize and verify provider
        working-directory: examples/test-cache-scoping/stack-a
        run: |
          terraform init
          # Verify AWS provider version ~5.0.0 was installed
          terraform version
  test-cache-scoping-stack-b:
    name: Test cache scoping - Stack B
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      lock-hash: ${{ steps.action.outputs.terraform-plugin-cache-dir }}
      tg-provider-cache-dir: ${{ steps.action.outputs.terragrunt-provider-cache-dir }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./
        id: action
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-cache-scoping/stack-b
          skip-caches: false
          enable-debug: true
      - name: Verify cache directory contains stack-b hash
        run: |
          cache_dir="${TF_PLUGIN_CACHE_DIR}"
          echo "TF Plugin Cache directory: $cache_dir"
          # Extract hash from path (last component)
          hash=$(basename "$cache_dir")
          echo "Hash: $hash"
          # Verify it's not a generic hash
          if [[ "$hash" == "no-lock" ]]; then
            echo "ERROR: Got generic 'no-lock' hash - scoping failed!"
            exit 1
          fi
          echo "✓ TF Plugin cache is scoped with unique hash: $hash"

          # Verify Terragrunt provider cache directory is the shared location under TG_DOWNLOAD_DIR
          tg_cache_dir="${TG_PROVIDER_CACHE_DIR}"
          tg_cache_dir="${tg_cache_dir//\/\//\/}" # normalize double slashes
          tg_cache_dir="${tg_cache_dir%/}" # trim trailing slash
          echo "TG Provider Cache directory: $tg_cache_dir"
          expected_path="$HOME/.terragrunt-cache/terragrunt/providers"
          if [[ "$tg_cache_dir" != "$expected_path" ]]; then
            echo "ERROR: TG provider cache is not using shared location!"
            echo "Expected: $expected_path"
            echo "Got: $tg_cache_dir"
            exit 1
          fi
          echo "✓ TG Provider cache uses shared location"
      - name: Initialize and verify provider
        working-directory: examples/test-cache-scoping/stack-b
        run: |
          terraform init
          # Verify AWS provider version ~5.5.0 was installed
          terraform version
  test-cache-scoping-validation:
    name: Validate cache scoping - Different hashes
    runs-on: ubuntu-24.04
    needs: [test-cache-scoping-stack-a, test-cache-scoping-stack-b]
    steps:
      - name: Compare cache directories
        run: |
          hash_a="${{ needs.test-cache-scoping-stack-a.outputs.lock-hash }}"
          hash_b="${{ needs.test-cache-scoping-stack-b.outputs.lock-hash }}"
          tg_hash_a="${{ needs.test-cache-scoping-stack-a.outputs.tg-provider-cache-dir }}"
          tg_hash_b="${{ needs.test-cache-scoping-stack-b.outputs.tg-provider-cache-dir }}"

          echo "Stack A TF plugin cache: $hash_a"
          echo "Stack B TF plugin cache: $hash_b"
          echo "Stack A TG provider cache: $tg_hash_a"
          echo "Stack B TG provider cache: $tg_hash_b"

          # Verify TF plugin caches are different (hash-scoped per stack)
          if [[ "$hash_a" == "$hash_b" ]]; then
            echo "ERROR: Both stacks have identical TF plugin cache directories!"
            echo "This means TF cache scoping is NOT working correctly."
            exit 1
          fi
          echo "✓ SUCCESS: Stacks have different TF plugin cache directories"

          # Verify TG provider caches are the SAME (shared location)
          if [[ "$tg_hash_a" != "$tg_hash_b" ]]; then
            echo "ERROR: Stacks have different TG provider cache directories!"
            echo "TG provider cache should be a shared location."
            echo "Stack A: $tg_hash_a"
            echo "Stack B: $tg_hash_b"
            exit 1
          fi
          echo "✓ SUCCESS: Stacks share the same TG provider cache directory"
          echo "Cache configuration is correct: TF plugin cache is scoped per stack, TG provider cache is shared!"
  test-cache-inputs-disabled:
    name: Test cache toggles disabled
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Run action with cache toggles disabled
        uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt
          skip-caches: true
          cache-tenv-tools: false
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true
      - name: Initialize with terragrunt (caches disabled)
        working-directory: examples/test-pr-comment-terragrunt
        run: |
          terragrunt run --all -- init
  test-cache-terraform-only-disabled:
    name: Test cache toggle - TF plugins disabled
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Run action with TF plugin cache disabled
        uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt
          skip-caches: false
          cache-terraform-plugins: false
          cache-terragrunt-caches: true
          cache-tenv-tools: false
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true
      - name: Initialize with terragrunt (TF cache disabled)
        working-directory: examples/test-pr-comment-terragrunt
        run: |
          terragrunt run --all -- init
  test-cache-terragrunt-only-disabled:
    name: Test cache toggle - TG caches disabled
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Run action with TG caches disabled
        uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-pr-comment-terragrunt
          skip-caches: false
          cache-terraform-plugins: true
          cache-terragrunt-caches: false
          cache-tenv-tools: false
          terragrunt-download: $HOME/.terragrunt-cache/${{ github.job }}
          enable-debug: true
      - name: Initialize with terragrunt (TG caches disabled)
        working-directory: examples/test-pr-comment-terragrunt
        run: |
          terragrunt run --all -- init
  test-cache-populate:
    name: Test cache population (run 1)
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: First run - populate cache
        uses: ./
        id: first-run
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          skip-caches: false
          terragrunt-download: $HOME/.terragrunt-cache/test-cache-shared
          enable-debug: true
      - name: Initialize with terragrunt --provider-cache (first run)
        working-directory: examples/test-pr-comment-terragrunt
        run: |
          echo "=== First terragrunt init with --provider-cache ==="
          terragrunt run --all --provider-cache -- plan
          echo "✓ First init completed"
      - name: Debug - Check populated cache contents
        run: |
          echo "=== Checking populated cache directories (before cache save) ==="

          echo "--- TF Plugin Cache Directory ---"
          echo "TF_PLUGIN_CACHE_DIR: ${TF_PLUGIN_CACHE_DIR}"
          if [[ -d "${TF_PLUGIN_CACHE_DIR}" ]]; then
            echo "Directory exists, contents:"
            ls -lah "${TF_PLUGIN_CACHE_DIR}" || true
            find "${TF_PLUGIN_CACHE_DIR}" -type f -name "terraform-provider-*" || true
          else
            echo "WARN: TF_PLUGIN_CACHE_DIR does not exist (expected for Terragrunt-only usage)"
          fi

          echo ""
          echo "--- TG Download Directory ---"
          echo "TG_DOWNLOAD_DIR: ${TG_DOWNLOAD_DIR}"
          if [[ -d "${TG_DOWNLOAD_DIR}" ]]; then
            echo "Directory exists, top-level contents:"
            ls -lah "${TG_DOWNLOAD_DIR}" || true
            echo ""
            echo "Searching for .terraform directories:"
            find "${TG_DOWNLOAD_DIR}" -type d -name ".terraform" -exec echo "Found: {}" \; -exec ls -lah {} \; 2>/dev/null || echo "No .terraform directories found"
          else
            echo "ERROR: TG_DOWNLOAD_DIR does not exist!"
          fi

          echo ""
          echo "--- TG Provider Cache Directory ---"
          echo "TG_PROVIDER_CACHE_DIR: ${TG_PROVIDER_CACHE_DIR}"
          if [[ -d "${TG_PROVIDER_CACHE_DIR}" ]]; then
            echo "Directory exists, contents:"
            ls -lah "${TG_PROVIDER_CACHE_DIR}" || true
            provider_count=$(find "${TG_PROVIDER_CACHE_DIR}" -type f -name "terraform-provider-*" 2>/dev/null | wc -l)
            echo "Provider binaries found: $provider_count"
            find "${TG_PROVIDER_CACHE_DIR}" -type f -name "terraform-provider-*" || true
          else
            echo "ERROR: TG_PROVIDER_CACHE_DIR does not exist!"
          fi
      - name: Verify caches were populated
        run: |
          tg_cache="${TG_PROVIDER_CACHE_DIR}"

          echo "Checking TG provider cache: $tg_cache"
          if [[ ! -d "$tg_cache" ]] || [[ -z "$(ls -A "$tg_cache" 2>/dev/null)" ]]; then
            echo "ERROR: TG provider cache was not populated!"
            echo "Make sure --provider-cache flag is used with terragrunt commands"
            exit 1
          fi

          provider_count=$(find "$tg_cache" -type f -name "terraform-provider-*" 2>/dev/null | wc -l)
          echo "✓ TG provider cache populated with $provider_count providers"

          # Cache will be saved in post action when job completes successfully
  test-cache-restore:
    name: Test cache restoration (run 2)
    runs-on: ubuntu-24.04
    needs: test-cache-populate
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Second run - should restore cache
        uses: ./
        id: second-run
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.DEFAULT_TERRAGRUNT_VERSION }}
          use-aws-auth: false
          skip-caches: false
          terragrunt-download: $HOME/.terragrunt-cache/test-cache-shared
          enable-debug: true
      - name: Debug - Check restored cache contents
        run: |
          echo "=== Checking restored cache directories ==="

          echo "--- TF Plugin Cache Directory ---"
          echo "TF_PLUGIN_CACHE_DIR: ${TF_PLUGIN_CACHE_DIR}"
          if [[ -d "${TF_PLUGIN_CACHE_DIR}" ]]; then
            echo "Directory exists, contents:"
            ls -lah "${TF_PLUGIN_CACHE_DIR}" || true
            find "${TF_PLUGIN_CACHE_DIR}" -type f -name "terraform-provider-*" || true
          else
            echo "ERROR: TF_PLUGIN_CACHE_DIR does not exist!"
          fi

          echo ""
          echo "--- TG Download Directory ---"
          echo "TG_DOWNLOAD_DIR: ${TG_DOWNLOAD_DIR}"
          if [[ -d "${TG_DOWNLOAD_DIR}" ]]; then
            echo "Directory exists, top-level contents:"
            ls -lah "${TG_DOWNLOAD_DIR}" || true
            echo ""
            echo "Searching for .terraform directories:"
            find "${TG_DOWNLOAD_DIR}" -type d -name ".terraform" -exec echo "Found: {}" \; -exec ls -lah {} \; 2>/dev/null || echo "No .terraform directories found"
          else
            echo "ERROR: TG_DOWNLOAD_DIR does not exist!"
          fi

          echo ""
          echo "--- TG Provider Cache Directory ---"
          echo "TG_PROVIDER_CACHE_DIR: ${TG_PROVIDER_CACHE_DIR}"
          if [[ -d "${TG_PROVIDER_CACHE_DIR}" ]]; then
            echo "Directory exists, contents:"
            ls -lah "${TG_PROVIDER_CACHE_DIR}" || true
            provider_count=$(find "${TG_PROVIDER_CACHE_DIR}" -type f -name "terraform-provider-*" 2>/dev/null | wc -l)
            echo "Provider binaries found: $provider_count"
            find "${TG_PROVIDER_CACHE_DIR}" -type f -name "terraform-provider-*" || true
          else
            echo "ERROR: TG_PROVIDER_CACHE_DIR does not exist!"
          fi
      - name: Verify cache restored - run plan without init
        working-directory: examples/test-pr-comment-terragrunt
        env:
          TG_NO_AUTO_INIT: 1 # Ensure we rely on restored cache - will fail if cache not restored properly
        run: |
          echo "=== Running plan with TG_NO_AUTO_INIT=1 (no init, cache must be complete) ==="
          time terragrunt run --all --provider-cache -- plan
          echo "✓ Plan succeeded - cache was properly restored!"
      - name: Verify caches were restored
        run: |
          # Check that cache directories still exist and have content
          tg_cache="${TG_PROVIDER_CACHE_DIR}"

          echo "Checking TG provider cache restoration: $tg_cache"
          tg_provider_count=$(find "$tg_cache" -type f -name "terraform-provider-*" 2>/dev/null | wc -l)
          echo "Cached providers in TG provider cache: $tg_provider_count"

          if [[ "$tg_provider_count" -eq 0 ]]; then
            echo "ERROR: No providers found in TG cache after second run!"
            exit 1
          fi
          echo "✓ TG provider cache hit verified"
          echo "✓ TG provider cache successfully restored and reused"
  test-cache-invalidation:
    name: Test cache invalidation on lockfile change
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: First run - populate cache with stack-a
        uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ""
          use-aws-auth: false
          working-directory: examples/test-cache-scoping/stack-a
          skip-caches: false
          enable-debug: true
      - name: Initialize stack-a
        working-directory: examples/test-cache-scoping/stack-a
        run: terraform init
      - name: Get first cache key
        run: |
          first_cache="${TF_PLUGIN_CACHE_DIR}"
          echo "FIRST_CACHE_DIR=$first_cache" >> $GITHUB_ENV
          echo "First cache directory: $first_cache"
      - name: Second run - different lockfile (stack-b)
        uses: ./
        env:
          TENV_GITHUB_TOKEN: ${{ github.token }}
        with:
          terraform-version: ${{ env.DEFAULT_TERRAFORM_VERSION }}
          use-aws-auth: false
          working-directory: examples/test-cache-scoping/stack-b
          skip-caches: false
          enable-debug: true
      - name: Initialize stack-b
        working-directory: examples/test-cache-scoping/stack-b
        run: terraform init
      - name: Verify different cache directory
        run: |
          second_cache="${TF_PLUGIN_CACHE_DIR}"
          echo "Second cache directory: $second_cache"

          if [[ "$FIRST_CACHE_DIR" == "$second_cache" ]]; then
            echo "ERROR: Cache was not invalidated - using same directory!"
            echo "First:  $FIRST_CACHE_DIR"
            echo "Second: $second_cache"
            exit 1
          fi

          echo "✓ Cache invalidation verified - different lockfile uses different cache"
